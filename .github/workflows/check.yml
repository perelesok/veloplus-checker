name: VeloPlus Check

on:
  schedule:
    - cron: '*/30 7-20 * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check availability and notify
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          check_url() {
            local label="$1"
            local url="$2"
            
            http_code=$(curl -s -o /tmp/response.json -w "%{http_code}" "$url")
            
            if [ "$http_code" != "200" ]; then
                printf "‚ö†Ô∏è <b>[%s]</b> ‚Äî –æ—à–∏–±–∫–∞ HTTP %s" "$label" "$http_code"
                return
            fi
            
            response=$(cat /tmp/response.json)
            
            if ! echo "$response" | jq -e 'type == "array"' > /dev/null 2>&1; then
                printf "‚ö†Ô∏è <b>[%s]</b> ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞" "$label"
                return
            fi
            
            array_length=$(echo "$response" | jq 'length')
            if [ "$array_length" == "0" ]; then
                printf "‚ö†Ô∏è <b>[%s]</b> ‚Äî –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API" "$label"
                return
            fi
            
            if ! echo "$response" | jq -e '.[0] | has("availability") and has("site")' > /dev/null 2>&1; then
                printf "‚ö†Ô∏è <b>[%s]</b> ‚Äî –∏–∑–º–µ–Ω–∏–ª—Å—è —Ñ–æ—Ä–º–∞—Ç API" "$label"
                return
            fi
            
            available=$(echo "$response" | jq -r '[.[] | select(.availability != "UNAVAILABLE")] | 
                if length == 0 then 
                    empty 
                else 
                    .[] | "  ‚Ä¢ \(.site.name): \(.availability) - \(.firstAvailableSlot)"
                end')
            
            unavailable_count=$(echo "$response" | jq '[.[] | select(.availability == "UNAVAILABLE")] | length')
            
            if [ -n "$available" ]; then
                printf "‚úÖ <b>[%s]</b>\n%s" "$label" "$available"
            else
                printf "‚ùå <b>[%s]</b> ‚Äî –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö (%s —Ç–æ—á–µ–∫ UNAVAILABLE)" "$label" "$unavailable_count"
            fi
          }

          r2=$(check_url "201" 'https://boutique.veloplus-m.fr/pu/sites/stock?offer_quantities=%7B%22201%22%3A1%7D')
          r3=$(check_url "202" 'https://boutique.veloplus-m.fr/pu/sites/stock?offer_quantities=%7B%22202%22%3A1%7D')
          r4=$(check_url "210" 'https://boutique.veloplus-m.fr/pu/sites/stock?offer_quantities=%7B%22210%22%3A1%7D')

          message="üö≤ VeloPlus —Å—Ç–∞—Ç—É—Å:

          ${r2}

          ${r3}

          ${r4}"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${message}" \
            -d parse_mode="HTML"
